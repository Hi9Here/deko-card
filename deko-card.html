<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../link-display/link-display.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icons/social-icons.html">
<link rel="import" href="../iron-icons/image-icons.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<!--
  `<deko-card></deko-card>` card display for deko
  @demo demo.html
-->
<dom-module id="deko-card">
  <template>
    <style>
      paper-material {
        background-color: #fafafa;
        color: #212121;
        height: 260px;
        width: 200px;
        display: inline-block;
        margin: 5px;
        overflow: hidden;
        cursor: pointer; 
        cursor: hand;
      }
    </style>
    <paper-material on-tap="tapped" elevation="2" inner-h-t-m-l="[[getHtml(card,edit)]]"></paper-material>    
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-card",
    properties:{
      card:Object,
      edit:{
        type:Boolean,
        value:false,
      }
    },
    getHtml: function(card, edit){
      var output
      if (card._output) {
        output = card._output + ""
        for (var attr in card) {
          if (attr !== "_data" || attr !== "_output") {
            //replace {{}}
            re = new RegExp("{{"+attr+"}}", "gim")
            output = output.replace(re, card[attr])
          }
        }
      } else {
        var outputType
        if (card.outputType) {
          outputType = card.outputType
        } else {
          outputType = "link-display"  
        }
        var outputContent
        if (card.content) {
          outputContent = card.content
        } else {
          outputContent = ""
        }
        var outAttrs = ""
        if (edit) {
          outAttrs = " edit"
        }
        for (var attr in card) {
          if (attr !== "_data" || attr !== "output") {
            //replace {{}}
            re = new RegExp("{{"+attr+"}}", "gim")
            outputContent = outputContent.replace(re, card[attr])
            if (attr ) {
            }
            outAttrs = outAttrs + " " + attr + "='" + card[attr]+ "' " 
          }
        }
        output = "<"+ outputType + outAttrs + " >" + outputContent + "</"+ outputType + ">"
      }

      return output
    },
    tapped: function(e) {
      var card = null
      var cardType = this.card.outputType || "link-display" 
      if (card = e.target.querySelector(cardType)){
      } else if (card = e.target.parentNode.querySelector(cardType)){
      } else if (card = e.target.parentNode.parentNode.querySelector(cardType)){
      } else if (card = e.target.parentNode.parentNode.parentNode.querySelector(cardType)){
      } else if (card = e.target.parentNode.parentNode.parentNode.parentNode.querySelector(cardType)){
      } else if (card = e.target.parentNode.parentNode.parentNode.parentNode.parentNode.querySelector(cardType)){
      } else if (card = e.target.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.querySelector(cardType)){
      }
      
      if (card) {
        var key = card.attributes.__key.value

        for (var i = 0, atts = card.attributes, n = atts.length, cardData = {}; i < n; i++){
          cardData[atts[i].nodeName] = atts[i].nodeValue
        }
        var target = e.target
        this.fire("tapped",{card: cardData, cardType: cardType, key: key, target: target})
      } else {
        console.log(e.target)
      }
    },
  })
</script>
