<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<!--
  `deko-card`
  @demo demo/index.html
-->

<dom-module id="deko-card">
  <template>
    <style>
      paper-material {
        background-color: #fafafa;
        color: #212121;
        height: var(--deko-card-height, 260px);
        width: var(--deko-card-width, 200px);
        display: inline-block;
        margin: 5px;
        overflow: hidden;
        cursor: pointer; 
        cursor: hand;
      }
      paper-material.mobile {
        height: var(--deko-card-sm-height, calc(100% - 260px));
        width: var(--deko-card-sm-width, 100%);
        margin: 0px 0px 0px 2px;
        box-shadow: 0 -2px 0px 0 rgba(0, 0, 0, 0.14),
                    0 -1px 0px 0 rgba(0, 0, 0, 0.12),
                    0 -3px 1px -2px rgba(0, 0, 0, 0.2);
      }
      paper-toolbar {
        --paper-toolbar-sm-height: 35px;
        --paper-toolbar-height: 35px;
        box-shadow: 0 -2px 0px 0 rgba(0, 0, 0, 0.14),
                    0 -1px 0px 0 rgba(0, 0, 0, 0.12),
                    0 -3px 1px -2px rgba(0, 0, 0, 0.2);
      }
    </style>
    <iron-media-query query="(min-width: 700px)" query-matches="{{wide}}"></iron-media-query>
    <!-- Desktop Layout -->
    <template is="dom-if" if="{{wide}}">
      <paper-material elevation="1">
        <paper-toolbar style$="background:[[_bg]];color:[[_fg]]">
          <iron-icon icon="[[icon]]" style="height:90%"></iron-icon>
          <div class="title" ></div>
          <template is="dom-if" if="{{edit}}">
            <iron-icon id="edit" on-tap="openoptions" icon="more-vert" style="height:90%"></iron-icon>
          </template>
        </paper-toolbar>
        <div inner-h-t-m-l="[[_getHtml(card,edit)]]"></div>
      </paper-material>
    </template>
    <!-- Mobile Layout -->
    <template is="dom-if" if="{{!wide}}">
      <paper-material class="mobile" elevation="1">
        <paper-toolbar style$="background:[[_bg]];color:[[_fg]]">
          <iron-icon icon="[[icon]]" style="height:90%"></iron-icon>
          <div class="title" ></div>
          <template is="dom-if" if="{{edit}}">
            <iron-icon id="edit" on-tap="openoptions" icon="more-vert" style="height:90%"></iron-icon>
          </template>
        </paper-toolbar>
        <div inner-h-t-m-l="[[_getHtml(card,edit)]]"></div>
      </paper-material>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-card",
    properties:{
      // If true, the edit button appears.
      edit:{
        type:Boolean,
        value:false,
      },
      // What icons appears in the card. This referes to the type of content. For example the link card's icon is bookmark.
      icon:String,
      // Refers to the color of the toolbar. These are based on material design color schemes.
      toolbarColor:String,
      _bg:{
        type:String,
        computed:"getBg(toolbarColor)",notify:true,
      },
      _fg:{
        type:String,
        computed:"getFg(_bg)",notify:true,
      },
      // This is what is displayed before it is used.
      card:Object,
    },
    _getHtml: function(card, edit){
      var output
      if (card._output) {
        output = card._output + ""
        for (var attr in card) {
          if (attr !== "_data" || attr !== "_output") {
            //replace {{}}
            re = new RegExp("{{"+attr+"}}", "gim")
            output = output.replace(re, card[attr])
          }
        }
      } else {
        var outputType
        if (card.outputType) {
          outputType = card.outputType
        } else if (card.cardType) {
          outputType = card.cardType
        } else {
          outputType = "link-display"  
        }
        var outputContent
        if (card.content) {
          outputContent = card.content
        } else {
          outputContent = ""
        }
        var outAttrs = ""
        if (edit) {
          outAttrs = " edit"
        }
        for (var attr in card) {
          if (attr !== "_data" || attr !== "output") {
            //replace {{}}
            re = new RegExp("{{"+attr+"}}", "gim")
            var theString
            if (typeof card[attr] === 'object') {
              theString =  JSON.stringify(card[attr] )
            } else {
              theString = card[attr] + ""
            }
            outputContent = outputContent.replace(re, card[attr] )
            
            if (attr ) {
            }
            outAttrs = outAttrs + " " + attr.split("_").join("") + "='" + theString + "' " 
          }
        }
        output = "<"+ outputType + outAttrs + " >" + outputContent + "</"+ outputType + ">"
      }
      return output
    },
    openoptions: function() {
      if (this.card) {
        this.fire("open-options", this.card)
      }
    },
    getBg: function(color){
      return color || Please.make_color({from_hash: this.innerText})
    },
    getFg: function(bg){
      var c = bg.substring(1);     // strip #
      var rgb = parseInt(c, 16);   // convert rrggbb to decimal
      var r = (rgb >> 16) & 0xff;  // extract red
      var g = (rgb >>  8) & 0xff;  // extract green
      var b = (rgb >>  0) & 0xff;  // extract blue
      var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b; // per ITU-R BT.709
      if (luma > 128) {
        return "#000"
      } else {
        return "#FFF"
      }
    },
  })
</script>
